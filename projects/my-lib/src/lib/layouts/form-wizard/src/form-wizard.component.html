<ng-template
  #StepFormGroup
  let-stepIndex="stepIndex"
  let-stepId="stepId"
  let-stepLabel="stepLabel"
  let-stepForm="stepForm"
  let-stepFields="stepFields"
>
  <form [formGroup]="stepForm">
    <p-fluid>
      <div class="flex">
        <div class="card flex flex-col gap-6 w-full">
          <div class="font-semibold text-xl">{{ stepLabel }}</div>
          <div class="flex flex-col gap-6">
            @for (field of stepFields; track field) {
              @if (field.visible !== false) {
                <div class="flex flex-col gap-2 w-full">
                  <ng-container
                    [ngTemplateOutlet]="FormField"
                    [ngTemplateOutletContext]="{
                      field: field,
                      stepForm: stepForm,
                    }"
                  ></ng-container>
                </div>
              }
            }
          </div>

          <ng-container [ngTemplateOutlet]="FormButtons"></ng-container>
        </div>
      </div>
    </p-fluid>
  </form>
</ng-template>

@if (steps.length > 1) {
  <p-stepper [(value)]="activeStep" [linear]="true">
    <p-step-list>
      @for (step of steps; track step.name; let i = $index) {
        <p-step [value]="i">{{ step.label }}</p-step>
      }
    </p-step-list>
    <p-step-panels>
      @for (step of steps; track step.name; let i = $index) {
        <p-step-panel [value]="i">
          <ng-template #content>
            <ng-container
              [ngTemplateOutlet]="StepFormGroup"
              [ngTemplateOutletContext]="{
                stepIndex: i,
                stepId: step.id,
                stepLabel: step.label,
                stepForm: form,
                stepFields: getFieldsForStep(step.id),
              }"
            ></ng-container>
          </ng-template>
        </p-step-panel>
      }
    </p-step-panels>
  </p-stepper>
}
@if (steps.length === 1) {
  <ng-container
    [ngTemplateOutlet]="StepFormGroup"
    [ngTemplateOutletContext]="{
      stepIndex: 0,
      stepId: steps[0].id,
      stepLabel: steps[0].label,
      stepForm: form,
      stepFields: getFieldsForStep(0),
    }"
  ></ng-container>
}
<ng-template #FormField let-field="field" let-stepForm="stepForm">
  <nz-form-field-renderer
    [config]="{ type: field.type, fieldConfig: field.fieldConfig }"
  ></nz-form-field-renderer>
  <small class="p-error" *ngIf="form.get(field.name)?.invalid && form.get(field.name)?.touched">
    Invalid {{ field.label }}
  </small>
</ng-template>

<ng-template #FormButtons>
  <!-- Navigation -->
  <div class="flex gap-2 justify-content-between mt-3">
    <button
      pButton
      label="Previous"
      icon="pi pi-arrow-left"
      (click)="activeStep = activeStep - 1"
      *ngIf="activeStep > 0"
    ></button>
    <button
      pButton
      label="Next"
      icon="pi pi-arrow-right"
      (click)="activeStep = activeStep + 1"
      *ngIf="activeStep < steps.length - 1"
    ></button>
    <button
      pButton
      label="Submit"
      icon="pi pi-check"
      (click)="save($event)"
      *ngIf="activeStep === steps.length - 1 && !isEdit"
    ></button>
    <button
      pButton
      label="Update"
      icon="pi pi-check"
      (click)="save($event)"
      *ngIf="activeStep === steps.length - 1 && !!isEdit"
    ></button>
    @if (stepperConfig.backBtn && stepperConfig.backBtn.position === 'inline') {
      <button
        label="Cancel"
        pButton
        severity="secondary"
        icon="pi pi-angle-left"
        (click)="stepperConfig.backBtn.btnCallback()"
      ></button>
    }
  </div>
</ng-template>
