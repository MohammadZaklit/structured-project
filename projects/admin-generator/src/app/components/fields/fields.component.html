<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col"><h2>Fields Management</h2></div>
    <div class="col-auto"><button pButton label="Add Field" icon="pi pi-plus" class="p-button-success" (click)="showAddDialog()"></button></div>
  </div>
  <div class="row mb-3"><div class="col"><div class="card"><div class="row g-3">
    <div class="col-md-3"><label>Module</label>
      <p-select [options]="modules" [(ngModel)]="filterModuleId" optionLabel="name" optionValue="id" [filter]="true" placeholder="Select" [showClear]="true" styleClass="w-100"></p-select>
    </div>
    <div class="col-md-3"><label>Reference Module</label>
      <p-select [options]="modules" [(ngModel)]="filterReferenceModuleId" optionLabel="name" optionValue="id" [filter]="true" placeholder="Select" [showClear]="true" styleClass="w-100"></p-select>
    </div>
    <div class="col-md-3"><label>Name</label><input pInputText [(ngModel)]="filterName" placeholder="Search" class="w-100"/></div>
    <div class="col-md-3" style="align-self: end;">
      <button pButton label="Apply" icon="pi pi-filter" (click)="applyFilters()"></button>
      <button pButton label="Clear" icon="pi pi-times" class="p-button-outlined ms-2" (click)="clearFilters()"></button>
    </div>
  </div></div></div></div>
  <div class="row"><div class="col"><div class="card">
    <p-table [value]="fields" [loading]="loading" styleClass="p-datatable-gridlines" [paginator]="true" [rows]="10" [reorderableColumns]="true" (onRowReorder)="onRowReorder($event)">
      <ng-template pTemplate="header">
        <tr><th style="width:3rem"></th><th>Name</th><th>Label</th><th>Module</th><th>Type</th><th>Ref Module</th><th>Order</th><th style="width:150px">Actions</th></tr>
      </ng-template>
      <ng-template pTemplate="body" let-field let-index="rowIndex">
        <tr [pReorderableRow]="index">
          <td><span class="pi pi-bars" pReorderableRowHandle></span></td>
          <td>{{field.name}}</td><td>{{field.label}}</td><td>{{field.module?.name}}</td><td>{{field.type}}</td><td>{{field.reference_module?.name||'-'}}</td><td>{{field.display_order}}</td>
          <td>
            <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-info" (click)="showEditDialog(field)" pTooltip="Edit"></button>
            <button pButton icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger" (click)="confirmDelete(field)" pTooltip="Delete"></button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage"><tr><td colspan="8" class="text-center py-4">No fields</td></tr></ng-template>
    </p-table>
  </div></div></div>
</div>

<p-dialog [(visible)]="displayDialog" [header]="isEditMode ? 'Edit Field' : 'Add Field'" [modal]="true" [style]="{width:'700px'}">
  <div class="p-fluid"><div class="row">
    <div class="col-md-6 mb-3"><label>Name *</label><input pInputText [(ngModel)]="field.name" placeholder="Field name" class="w-100"/></div>
    <div class="col-md-6 mb-3"><label>Label *</label><input pInputText [(ngModel)]="field.label" placeholder="Label" class="w-100"/></div>
    <div class="col-md-6 mb-3"><label>Module *</label>
      <p-select [options]="modules" [(ngModel)]="field.module_id" optionLabel="name" optionValue="id" [filter]="true" placeholder="Select" styleClass="w-100"></p-select>
    </div>
    <div class="col-md-6 mb-3"><label>Type *</label>
      <p-select [options]="fieldTypes" [(ngModel)]="field.type" optionLabel="label" optionValue="name" [filter]="true" placeholder="Select" styleClass="w-100"></p-select>
    </div>
    <div class="col-12 mb-3"><label>Reference Module</label>
      <p-select [options]="modules" [(ngModel)]="field.reference_module_id" optionLabel="name" optionValue="id" [filter]="true" placeholder="Optional" [showClear]="true" styleClass="w-100"></p-select>
    </div>
  </div></div>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
    <button pButton label="Save" icon="pi pi-check" (click)="saveField()" [disabled]="!field.name.trim()||!field.label.trim()||!field.module_id||!field.type"></button>
  </ng-template>
</p-dialog>
<p-toast></p-toast><p-confirmDialog></p-confirmDialog>
